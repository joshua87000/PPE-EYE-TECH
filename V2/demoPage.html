<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Handy</title>

    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>


</head>


<style>

@font-face {
            font-family: "Futura";
            src: "font/futura/futur.ttf" format("truetype");
        }

    body {
       font-family: "Futura", sans-serif;
       position: relative;
    }
  header
  {
    display: flex ;
    align-items: center;
    justify-content: space-between
  }

  #try-demo
  {
    background-color: #F18D17 ;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    padding: 5px 10px 5px 10px;
    margin: 10px;
    font-size: 1.4em;
  }

  header a
  {
    text-decoration: none;
    color: black;
    margin: 10px;
    font-size: 1.4em;
  }

  header p
  {
    margin: 10px;
  }
  header img
  {
        width: 150px;
        height: auto;
  }

  #main-content
  {
    width: 100%;
    display: flex;
    justify-content: center;
    flex-direction: column;
    align-items: center;

  }

  #draw-box
  {
    border-radius: 10px;
    border: solid;
    width: 50%;
    height: 350px;
    margin-top: 80px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    
  }

  .loader {
    /* position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%); */


    width: 48px;
    height: 48px;
    border: 5px solid #FFF;
    border-bottom-color: #FF3D00;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
    } 

    #loading-box
    {
        display: flex;
        flex-direction: column;
        justify-content: center;
    align-items: center;

    }

    video
    {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%); 
        display: none;
        /* border: solid; */
        border-radius: 10px;
        width:320px;
        height:240px;
        transition: all 1s ease;
        z-index: 1;
       

    }

    video.small {
            top: 0%;
            left: 100%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 120px;
        }

        #say-hello
        {
            z-index: 10;
            color: #FFF;
            transition: all 0.5s ease;
        }

        #emoji.annim
        {
            display: inline-block;
            animation: rotateAnimation 2s infinite;
        }

      
  

  @keyframes rotateAnimation {
            0% {
                transform: rotate(0deg); /* Rotation initiale */
            }
            50% {
                transform: rotate(45deg); /* Rotation √† mi-chemin */
            }
            100% {
                transform: rotate(0deg); /* Rotation finale, revenant √† 0 degr√© */
            }
        }

        #handOn{
            position: absolute;
            top: 10px;
            left: 10px;
            width: 25px;
            height: auto;
            transform: translate(-50%,-50%);
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 12;
           
        }

        #myCanvas
        {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;

        }

        #tutoTxt
        {
            display: none;
            z-index: 30;
            color: #FFF;
            transition: all 1s ease;
            text-align: center;
            font-size: 1.4em;
        }

        .colorBox
    {
        padding :5px;
        border-radius: 7px;

    }

    .colorBox:hover
    {
        background-color: rgb(207, 207, 207);
    }


    .colorSelected
    {
        width: 30px;
        height: 30px;
        border: 2px solid;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .inColor
    {
        width: 85%;
        height: 85%;
        border-radius: 50px;
    }

    #color-picker
    {
        display: flex;
        position: absolute;
        top: 0px;
        left :20px;
        z-index: 10;

        


    }

    #binBox
    {
        position: absolute;
        left:10px;
        bottom: 0px;
        padding: 5px;
        border-radius: 7px;
        z-index: 10;
    }

    #binBox img
    {
        width: 30px;
        height: auto;
    }


</style>
<body>
    <header> 
        <img src ="Image/Capture-removebg-preview.png">
        <div>
            <a href="https://www.example.com">About us</a>
            <a href="https://www.example.com">Contact</a>
            <a id = "try-demo" href="HandyLandingPage.html">Join the beta</a>
        </div>
    </header>

    <div id ="main-content">
        <h2>Utilisez vos doigts pour dessiner quelque chose a l'√©cran</h2>
        <div id ="draw-box">
            <div id ="loading-box">
                <span class="loader"></span>
                <p>Chargement de la cam√©ra</p>
            </div>
            <video id="videoInput"  autoplay></video>
            <img id ="handOn" src = "Image/handIcone.png" >
            <canvas id="myCanvas"></canvas>
            <p id = "tutoTxt"></p>
            <div id = "binBox">
                <img src ="Image/bin.png">
            </div>
            <div id = color-picker >
                <div class ="colorBox" onclick="selectColor(this)">
                    <div class = "colorSelected" style="border-color: black;">
                        <div class = "inColor" style="background-color: black;"></div>
                    </div>
                </div>
                <div class ="colorBox" onclick="selectColor(this)">
                    <div class = "colorSelected" style="border-color: rgba(255, 0, 0, 0);">
                        <div class = "inColor" style="background-color: red;"></div>
                    </div>
                </div>
                <div class ="colorBox" onclick="selectColor(this)">
                    <div class = "colorSelected" style="border-color: rgba(255, 0, 0, 0);">
                        <div class = "inColor" style="background-color: blue;"></div>
                    </div>
                </div>
                <div class ="colorBox" onclick="selectColor(this)">
                    <div class = "colorSelected" style="border-color: rgba(255, 0, 0, 0);">
                        <div class = "inColor" style="background-color: green;"></div>
                    </div>
                </div> 
            </div>
        </div>

        

        

    </div>

    <script type="text/javascript">

        tf.setBackend('webgl');
        console.log("Backend actuel :", tf.getBackend());

        var drawBox = document.getElementById("draw-box");
        var tutoTxt = document.getElementById("tutoTxt");
        var tutoStep = 0;
        var drawColor = "rgb(0,0,0)";
     

        async function runHandpose() {
            // Charger le mod√®le Handpose
            const model = await handpose.load();
           
            const videoElement = document.getElementById('videoInput');

           
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                   
                    const webcams = devices.filter(device => device.kind === 'videoinput');
                    console.log(webcams);

                    if (webcams.length > 1) {
                        
                        const webcamToUse = webcams[0];

                       
                        const constraints = {
                            video: {
                                deviceId: { exact: webcamToUse.deviceId },
                            },
                        };

                       
                        return navigator.mediaDevices.getUserMedia(constraints);
                        
                    } else {
                       
                        console.log('Aucune webcam trouv√©e, utilise la cam√©ra par d√©faut.');
                        return navigator.mediaDevices.getUserMedia({ video: true });
                    }
                })
                .then((stream) => {

                    videoElement.srcObject = stream;
                    console.log("stream");

                    // Attendre que la vid√©o soit charg√©e
                    videoElement.onloadedmetadata = async function () {
                        // Initialiser le canvas pour afficher le flux vid√©o
                        
                        // D√©tecter les mains dans le flux vid√©o
                        console.log("video charge");

                        var LoadingBox = document.getElementById("loading-box");
                        LoadingBox.remove();

                        var VideoBox = document.getElementById("videoInput");
                        VideoBox.style.display = "block";

                      
                       
                        tutoTxt.innerHTML = "Say hello to handy <span id = 'emoji' class = 'annim'>üëã<span>";
                        tutoTxt.style.display = "block";
                       
                       
                

                        var hello = 0;
                        var handOn = 0;
                        var handpos = 0;
                        var cmpFrameWhitoutHand = 0;
                        var cmpTuto = 0;
                    

                        async function detectHands() {  
                         
                            const hands = await model.estimateHands(videoElement);
                          

                           

                            // Afficher les rep√®res des mains
                            if(hands.length == 0 && handOn == 1)
                            {
                                cmpFrameWhitoutHand ++;
                                if(cmpFrameWhitoutHand == 8)
                                {
                                    document.getElementById("handOn").style.opacity = "0";
                                    handOn = 0;
                                    console.log("not hand");
                                }
                                
                            }

                            if(tutoStep == 1 && hands.length > 0)
                            {
                                cmpTuto++;
                                if(cmpTuto > 80)
                                {
                                    setTimeout(() => {
                                        newTutotxt("Do this sign to draw üëå");
                                        tutoStep = 2;
                                        cmpTuto=0;
                                        }, 2000);
                                   
                                }
                            }

                            if(tutoStep == 2 && cmpTuto > 60)
                            {
                                setTimeout(() => {
                                        newTutotxt("Nice !");
                                        tutoStep = 3;
                                        cmpTuto=0;
                                        }, 1000);
                            }

                            

                            

                            if (hands.length > 0) {
                               if(hands[0].landmarks[20][0] < hands[0].landmarks[4][0] )
                               {
                                    imageHand.style.transform = "scaleX(-1)";
                               }
                               else
                               {
                                    imageHand.style.transform = "scaleX(1)";
                               }

                               


                                hands.forEach(hand => {
                                    if(tutoStep == 0)
                                    {
                                        tutoStep = 1;
                                        VideoBox.classList.add("small");
                                        
                                        tutoTxt.style.color ="#F18D17";
                                        setTimeout(() => {
                                            newTutotxt("let's start !<br>Raise your hand and move it to face the screen ‚úã");

                                        }, 1000);
                                    }
                                    if(handOn == 0 && tutoStep > 0)
                                    {
                                        handOn = 1;
                                        document.getElementById("handOn").style.opacity = "1";
                                        cmpFrameWhitoutHand = 0;
                                    }
                                    var moyenneX = 0;
                                    var moyenneY = 0;



                                 

                                   
                                    
                                    moyenneX = hands[0].boundingBox.topLeft[0]+(hands[0].boundingBox.bottomRight[0]-hands[0].boundingBox.topLeft[0])/2;
                                    moyenneY = hands[0].boundingBox.topLeft[1]+(hands[0].boundingBox.bottomRight[1]-hands[0].boundingBox.topLeft[1])/2;

                                    moyenneX = moyenneX.toFixed(1);
                                    moyenneY = moyenneY.toFixed(1);

                                    let min_valeurX = 150;
                                    let max_valeurX = 450;

                                    let min_valeurY = 100;
                                    let max_valeurY = 300;


                                    pourcentageX = ((moyenneX - min_valeurX) / (max_valeurX - min_valeurX)) * 100;
                                    pourcentageX = 100-(Math.max(0, Math.min(100, pourcentageX)));

                                    pourcentageY = ((moyenneY - min_valeurY) / (max_valeurY - min_valeurY)) * 100;
                                    pourcentageY = Math.max(0, Math.min(100, pourcentageY));

                                    
                                 if(calculerDistance(hands[0].landmarks[4][0],hands[0].landmarks[4][1],hands[0].landmarks[8][0],hands[0].landmarks[8][1]) < 75 && handpos == 0)
                                    {
                                        document.getElementById("handOn").src = "Image/OkIcone.png";
                                        handpos = 1;
                                    }
                                    else if(handpos == 1 &&  calculerDistance(hands[0].landmarks[4][0],hands[0].landmarks[4][1],hands[0].landmarks[8][0],hands[0].landmarks[8][1]) > 75)
                                    {
                                        document.getElementById("handOn").src = "Image/handIcone.png";
                                        handpos = 0;
                                        lastX = 0;
                                        lastY = 0;
                                    }

                                    afficheHand(pourcentageY,pourcentageX);
                                    if(handpos == 1 && tutoStep > 1)
                                    {
                                        let dx = canvas.width*pourcentageX/100;
                                        let dy = canvas.height*pourcentageY/100;
                                        dessiner(dx , dy);
                                        if(tutoStep == 2)
                                            cmpTuto++;
                                        
                                    }


                                });
                            }

                            // Continuer la d√©tection en boucle
                            requestAnimationFrame(detectHands);
                        }

                        // D√©marrer la d√©tection des mains
                        detectHands();
                    };
                })
                .catch((err) => {
                    console.error('Erreur lors de l\'acc√®s √† la webcam : ', err);
                });
        }

        // Ex√©cuter la fonction lorsque TensorFlow.js est pr√™t
        tf.ready().then(() => {
            console.log(" tf ready");
            runHandpose();
        });

        function afficheHand(px,py)
        {
            var posHand = document.getElementById("handOn");
            posHand.style.top = px+"%";
            posHand.style.left = py+"%";
        }

        function calculerDistance(x1, y1, x2, y2) {
    
            let differenceX = x2 - x1;
            let differenceY = y2 - y1;

            
            let carreDifferenceX = differenceX * differenceX;
            let carreDifferenceY = differenceY * differenceY;

            
            let distance = Math.sqrt(carreDifferenceX + carreDifferenceY);

            return distance;
        }

        const canvas = document.getElementById('myCanvas');
        const context = canvas.getContext('2d');

        canvas.width = drawBox.offsetWidth;
        canvas.height = drawBox.offsetHeight;

        let dessinEnCours = false;
       
      
        var lastX =0;
        var lastY = 0;
        function dessiner(x, y) {
          
            if (!dessinEnCours) {
                context.beginPath();
            }

           
            context.lineWidth = 4;
            context.lineCap = 'round';
            context.strokeStyle = drawColor; 

            
            if(lastX !=0)
            {
                context.moveTo(lastX, lastY);
            }
           
                context.lineTo(x, y);
                context.stroke();
                lastX = x;
                lastY = y;
           
        }

        function newTutotxt(text)
        {
             tutoTxt.style.opacity = "0";

             setTimeout(() => {
                tutoTxt.innerHTML = text;
                tutoTxt.style.opacity = "1";
            }, 1000);
        }

        function selectColor(element)
        {
            var allBorder = document.querySelectorAll('.colorSelected');
            allBorder.forEach(function(item) {
                item.style.borderColor = 'rgba(255, 0, 0, 0)';
            });

             var border = element.querySelector('.colorSelected');
             var color = element.querySelector('.inColor');
             border.style.borderColor = color.style.backgroundColor;

             drawColor = color.style.backgroundColor;
        }

        var colorPicker = document.getElementById("color-picker");
        var imageHand = document.getElementById("handOn");
        var binBox = document.getElementById("binBox");

        function checkChevauchement(elementFixe,elementMobile) {
        
        var rectFixe = elementFixe.getBoundingClientRect();
        var rectMobile = elementMobile.getBoundingClientRect();

        // V√©rifier si les rectangles se chevauchent
        var chevauchement =
            rectMobile.left < rectFixe.right &&
            rectMobile.right > rectFixe.left &&
            rectMobile.top < rectFixe.bottom &&
            rectMobile.bottom > rectFixe.top;

        if (chevauchement) {
                return 1;
        } 
        else
        {
            return 0;
        }
       
    }

   var selectedColor = 0;
   var selectedBin = 0;
    setInterval(function() {
        if(checkChevauchement(colorPicker, imageHand) == 1)
        {
           
            var allColor = document.querySelectorAll('.colorBox');

            allColor.forEach(function(item) {
                item.style.backgroundColor = 'rgba(255, 0, 0, 0)';
            });

            let found = 0;
            allColor.forEach(function(item) {
                
                if(checkChevauchement(item,imageHand) == 1 && found == 0)
                {
                    item.style.backgroundColor = 'rgb(207, 207, 207)';
                    found = 2;
                }
            }); 
            
            selectedColor = 1;
        }
        else if(selectedColor == 1)
        {
            var allColor = document.querySelectorAll('.colorBox');

            allColor.forEach(function(item) {
                item.style.backgroundColor = 'rgba(255, 0, 0, 0)';
            });

            selectedColor = 0;
        }

        if(checkChevauchement(binBox, imageHand) == 1)
        {
            binBox.style.backgroundColor = 'rgba(255, 0, 0, 0.4)';
            selectedBin = 1;
        }
        else if(selectedBin == 1)
        {
            binBox.style.backgroundColor = 'rgba(255, 0, 0, 0)';
            selectedBin = 0;
        }
   
    }, 300);


  
    </script>

</body>
</html>